<script lang="ts">
  import { getEncodedTokenV4 } from "@cashu/cashu-ts";
  import { onMount } from "svelte";
  import NoteCanvas from "../components/note-designer/NoteCanvas.svelte";
  import {
    preparedTokens,
    selectedNumberOfNotes,
    selectedDenomination,
    wallet,
    currentTemplate,
    selectedTemplateId,
    prints,
    type Print,
  } from "./stores.svelte";
  import { getAmountForTokenSet } from "./utils";
  import ShareViaNostr from "./comp/ShareViaNostr.svelte";
  import {
    createMountainlakeTemplate,
    createComicTemplate,
    createCustomTemplate,
  } from "./template-converter";
  import type { NoteTemplate, NoteDesignContext } from "../types/note-designer";
  import encodeQR from "qr";
  import JSZip from "jszip";

  let active = $state("customize");
  let canvasRef: any[] = $state([]);

  // Initialize with existing template or generate new one
  onMount(() => {
    if (!$currentTemplate) {
      currentTemplate.set(generateTemplate());
    }
  });

  // Template configuration states
  // Mountainlake
  let topLeftIcon = $state<"cashu" | "bitcoin" | "sats" | "custom">("cashu");
  let customLogoUrl = $state("");
  let headerText = $state(
    "Cashu Token\nRedeemable with Cashu\nWallet of choice",
  );
  let headerTextColor = $state("#FFFFFF");
  let gradientStart = $state("#F77F00");
  let gradientEnd = $state("#7209B7");
  let qrBackgroundColor = $state("#FFFFFF");
  let qrBorderColor = $state("#F77F00");
  let qrCodeColor = $state("#000000");
  let denominationColor = $state("#F77F00");
  let bottomTextColor = $state("#666666");
  let customBottomText = $state("");

  // Custom template
  let colorCode = $state("#5db075");
  let brandLogoURL = $state("");
  let cornerBrandLogoURL = $state("");

  // Generate template based on selected template and config
  const generateTemplate = (): NoteTemplate => {
    if ($selectedTemplateId === "mountainlake") {
      return createMountainlakeTemplate({
        topLeftIcon,
        customLogoUrl,
        headerText,
        headerTextColor,
        gradientStart,
        gradientEnd,
        qrBackgroundColor,
        qrBorderColor,
        qrCodeColor,
        denominationColor,
        bottomTextColor,
        customBottomText,
      });
    } else if ($selectedTemplateId === "comic") {
      return createComicTemplate();
    } else {
      return createCustomTemplate({
        colorCode,
        brandLogoURL,
        cornerBrandLogoURL,
      });
    }
  };

  // Reactive template generation when user makes changes in customization
  $effect(() => {
    // Track all config dependencies
    void topLeftIcon;
    void customLogoUrl;
    void headerText;
    void headerTextColor;
    void gradientStart;
    void gradientEnd;
    void qrBackgroundColor;
    void qrBorderColor;
    void qrCodeColor;
    void denominationColor;
    void bottomTextColor;
    void customBottomText;
    void colorCode;
    void brandLogoURL;
    void cornerBrandLogoURL;
    void $selectedTemplateId;
    
    // Only update if we're in customize mode (user is actively editing)
    if (active === "customize") {
      const template = generateTemplate();
      currentTemplate.set(template);
    }
  });

  // Context for dynamic bindings
  const noteContext = $derived.by((): NoteDesignContext => {
    return {
      denomination: $selectedDenomination,
      mintUrl: $wallet?.mint.mintUrl || "",
      token: $preparedTokens[0]
        ? getEncodedTokenV4($preparedTokens[0])
        : "",
      unit: $wallet?.unit || "sat",
    };
  });

  // Download all notes as ZIP
  const downloadAll = async () => {
    const zip = new JSZip();

    for (let i = 0; i < $preparedTokens.length; i++) {
      const canvas = canvasRef[i];
      if (!canvas) continue;

      // Update context for this specific token
      const tokenContext: NoteDesignContext = {
        denomination: getAmountForTokenSet($preparedTokens[i].proofs),
        mintUrl: $wallet?.mint.mintUrl || "",
        token: getEncodedTokenV4($preparedTokens[i]),
        unit: $preparedTokens[i].unit || "sat",
      };

      // Export as PNG
      const dataUrl = await canvas.exportCanvas({
        format: "png",
        pixelRatio: 3,
      });

      // Convert data URL to blob
      const base64 = dataUrl.split(",")[1];
      const binary = atob(base64);
      const array = new Uint8Array(binary.length);
      for (let j = 0; j < binary.length; j++) {
        array[j] = binary.charCodeAt(j);
      }
      const blob = new Blob([array], { type: "image/png" });

      zip.file(`note-${i + 1}.png`, blob);
    }

    const content = await zip.generateAsync({ type: "blob" });
    const url = URL.createObjectURL(content);
    const link = document.createElement("a");
    link.href = url;
    link.download = `cashu-notes-${Date.now()}.zip`;
    link.click();
    URL.revokeObjectURL(url);
  };

  // Download QR codes only
  const downloadQRs = async () => {
    const zip = new JSZip();

    $preparedTokens.forEach((token, index) => {
      const svg = encodeQR(getEncodedTokenV4(token), "svg");
      zip.file(`qr-${index + 1}.svg`, svg);
    });

    const content = await zip.generateAsync({ type: "blob" });
    const url = URL.createObjectURL(content);
    const link = document.createElement("a");
    link.href = url;
    link.download = `cashu-qr-codes-${Date.now()}.zip`;
    link.click();
    URL.revokeObjectURL(url);
  };

  // Save template configuration when going to print
  const goToPrint = () => {
    // Update the most recent print with template info
    if ($prints.length > 0 && $currentTemplate) {
      prints.update((ctx) => {
        const updated = [...ctx];
        updated[0] = {
          ...updated[0],
          template: $currentTemplate,
          templateId: $selectedTemplateId,
        };
        return updated;
      });
    }
    active = "print";
  };

  // Preset themes
  const applyTheme = (
    theme:
      | "orange"
      | "purple"
      | "swiss-10"
      | "swiss-20"
      | "swiss-50"
      | "swiss-100"
      | "swiss-200"
      | "swiss-1000",
  ) => {
    if (theme === "orange") {
      gradientStart = "#F77F00";
      gradientEnd = "#7209B7";
      denominationColor = "#F77F00";
      qrBorderColor = "#F77F00";
      headerTextColor = "#FFFFFF";
    } else if (theme === "purple") {
      gradientStart = "#7209B7";
      gradientEnd = "#3A0CA3";
      denominationColor = "#7209B7";
      qrBorderColor = "#7209B7";
      headerTextColor = "#E0AAFF";
    } else if (theme === "swiss-10") {
      gradientStart = "#E8C547";
      gradientEnd = "#5C4A1C";
      denominationColor = "#E8C547";
      qrBorderColor = "#E8C547";
      bottomTextColor = "#4A3D19";
      qrBackgroundColor = "#E8C547";
      qrCodeColor = "#2D2416";
      headerTextColor = "#FFFFFF";
    } else if (theme === "swiss-20") {
      gradientStart = "#EA6311";
      gradientEnd = "#5D2706";
      denominationColor = "#EA6311";
      qrBorderColor = "#EA6311";
      bottomTextColor = "#3A1804";
      qrBackgroundColor = "#EA6311";
      qrCodeColor = "#2D1403";
      headerTextColor = "#FFFFFF";
    } else if (theme === "swiss-50") {
      gradientStart = "#44ABC7";
      gradientEnd = "#1B444F";
      denominationColor = "#44ABC7";
      qrBorderColor = "#44ABC7";
      bottomTextColor = "#112A31";
      qrBackgroundColor = "#44ABC7";
      qrCodeColor = "#0D1F25";
      headerTextColor = "#FFFFFF";
    } else if (theme === "swiss-100") {
      gradientStart = "#4A9AC9";
      gradientEnd = "#1C3D52";
      denominationColor = "#4A9AC9";
      qrBorderColor = "#4A9AC9";
      bottomTextColor = "#14293A";
      qrBackgroundColor = "#4A9AC9";
      qrCodeColor = "#0F1F2C";
      headerTextColor = "#FFFFFF";
    } else if (theme === "swiss-200") {
      gradientStart = "#B58F5B";
      gradientEnd = "#483924";
      denominationColor = "#B58F5B";
      qrBorderColor = "#B58F5B";
      bottomTextColor = "#2D2316";
      qrBackgroundColor = "#B58F5B";
      qrCodeColor = "#221A11";
      headerTextColor = "#FFFFFF";
    } else if (theme === "swiss-1000") {
      gradientStart = "#8B6BA8";
      gradientEnd = "#372A44";
      denominationColor = "#8B6BA8";
      qrBorderColor = "#8B6BA8";
      bottomTextColor = "#281F33";
      qrBackgroundColor = "#8B6BA8";
      qrCodeColor = "#1C1624";
      headerTextColor = "#FFFFFF";
    }
  };

  // Logo upload handler
  const handleLogoUpload = (e: Event) => {
    const target = e.target as HTMLInputElement;
    if (target.files && target.files[0]) {
      customLogoUrl = URL.createObjectURL(target.files[0]);
      topLeftIcon = "custom";
    }
  };

  const getBrandURL = (e: Event) => {
    const target = e.target as HTMLInputElement;
    if (target.files && target.files[0]) {
      brandLogoURL = URL.createObjectURL(target.files[0]);
    }
  };

  const getCornerURL = (e: Event) => {
    const target = e.target as HTMLInputElement;
    if (target.files && target.files[0]) {
      cornerBrandLogoURL = URL.createObjectURL(target.files[0]);
    }
  };
</script>

<div class="flex w-full items-center justify-center">
  <ul class="steps w-full max-w-2xl">
    <li class="step step-primary cursor-pointer" onclick={() => (active = "customize")}>
      Customize
    </li>
    <li
      class="step cursor-pointer"
      class:step-primary={active === "print"}
      onclick={goToPrint}
    >
      Print
    </li>
    <li
      class="step cursor-pointer"
      class:step-primary={active === "share"}
      onclick={() => (active = "share")}
    >
      Share
    </li>
  </ul>
</div>

{#if active === "customize"}
  <div class="flex flex-col gap-6 w-full items-center p-6">
    <!-- Template Selector -->
    <div class="flex flex-col gap-4 w-full max-w-4xl">
      <p class="font-bold text-lg">Select Template</p>
      <div class="flex gap-3 flex-wrap">
        <button
          class="btn {$selectedTemplateId === 'mountainlake' ? 'btn-primary' : 'btn-outline'}"
          onclick={() => selectedTemplateId.set("mountainlake")}
        >
          Mountainlake
        </button>
        <button
          class="btn {$selectedTemplateId === 'comic' ? 'btn-primary' : 'btn-outline'}"
          onclick={() => selectedTemplateId.set("comic")}
        >
          Comic
        </button>
        <button
          class="btn {$selectedTemplateId === 'custom' ? 'btn-primary' : 'btn-outline'}"
          onclick={() => selectedTemplateId.set("custom")}
        >
          Custom
        </button>
      </div>
    </div>

    <!-- Preview -->
    <div class="flex flex-col gap-4 items-center">
      <p class="font-bold">Preview</p>
      {#if $currentTemplate}
        <div class="scale-50 origin-top">
          <NoteCanvas
            template={$currentTemplate}
            context={noteContext}
            editable={false}
          />
        </div>
      {/if}
    </div>

    <!-- Mountainlake Customization -->
    {#if $selectedTemplateId === "mountainlake"}
      <div class="flex flex-col gap-4 w-full max-w-4xl">
        <p class="font-bold text-lg">Customize Mountainlake Template</p>
        
        <!-- Quick Themes -->
        <div class="flex flex-col gap-2">
          <label class="label font-semibold">Quick Themes</label>
          <div class="flex gap-2 flex-wrap">
            <button class="btn btn-sm" onclick={() => applyTheme("orange")}>Orange</button>
            <button class="btn btn-sm" onclick={() => applyTheme("purple")}>Purple</button>
            <button class="btn btn-sm" onclick={() => applyTheme("swiss-10")}>CHF 10</button>
            <button class="btn btn-sm" onclick={() => applyTheme("swiss-20")}>CHF 20</button>
            <button class="btn btn-sm" onclick={() => applyTheme("swiss-50")}>CHF 50</button>
            <button class="btn btn-sm" onclick={() => applyTheme("swiss-100")}>CHF 100</button>
            <button class="btn btn-sm" onclick={() => applyTheme("swiss-200")}>CHF 200</button>
            <button class="btn btn-sm" onclick={() => applyTheme("swiss-1000")}>CHF 1000</button>
          </div>
        </div>

        <!-- Background Gradient -->
        <div class="flex flex-col gap-2">
          <label class="label font-semibold">Background Gradient</label>
          <div class="flex gap-4">
            <div class="flex flex-col gap-1">
              <label class="text-sm">Start Color</label>
              <input type="color" bind:value={gradientStart} class="input input-bordered w-20 h-10" />
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-sm">End Color</label>
              <input type="color" bind:value={gradientEnd} class="input input-bordered w-20 h-10" />
            </div>
          </div>
        </div>

        <!-- Header Text -->
        <div class="flex flex-col gap-2">
          <label class="label">Header Text</label>
          <textarea bind:value={headerText} class="textarea textarea-bordered" rows="3"></textarea>
          <div class="flex gap-2 items-center">
            <label class="text-sm">Color</label>
            <input type="color" bind:value={headerTextColor} class="input input-bordered w-20 h-10" />
          </div>
        </div>

        <!-- QR Code Styling -->
        <div class="flex flex-col gap-2">
          <label class="label font-semibold">QR Code Area</label>
          <div class="flex gap-4 flex-wrap">
            <div class="flex flex-col gap-1">
              <label class="text-sm">Background</label>
              <input type="color" bind:value={qrBackgroundColor} class="input input-bordered w-20 h-10" />
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-sm">Border</label>
              <input type="color" bind:value={qrBorderColor} class="input input-bordered w-20 h-10" />
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-sm">QR Color</label>
              <input type="color" bind:value={qrCodeColor} class="input input-bordered w-20 h-10" />
            </div>
          </div>
        </div>

        <!-- Denomination Color -->
        <div class="flex flex-col gap-2">
          <label class="label font-semibold">Denomination Display</label>
          <div class="flex gap-2 items-center">
            <label class="text-sm">Color</label>
            <input type="color" bind:value={denominationColor} class="input input-bordered w-20 h-10" />
          </div>
        </div>

        <!-- Bottom Text -->
        <div class="flex flex-col gap-2">
          <label class="label">Bottom Text</label>
          <textarea bind:value={customBottomText} class="textarea textarea-bordered" rows="2" placeholder="Leave empty for auto (mint URL)"></textarea>
          <div class="flex gap-2 items-center">
            <label class="text-sm">Color</label>
            <input type="color" bind:value={bottomTextColor} class="input input-bordered w-20 h-10" />
          </div>
        </div>
      </div>
    {/if}

    <!-- Custom Template Customization -->
    {#if $selectedTemplateId === "custom"}
      <div class="flex flex-col gap-4 w-full max-w-4xl">
        <p class="font-bold text-lg">Customize Template</p>
        
        <div class="flex flex-col gap-2">
          <label class="label">Background Color</label>
          <input type="color" bind:value={colorCode} class="input input-bordered w-20 h-10" />
        </div>

        <div class="flex flex-col gap-2">
          <label class="label">Brand Logo</label>
          <input type="file" accept="image/*" onchange={getBrandURL} class="file-input file-input-bordered w-full" />
        </div>

        <div class="flex flex-col gap-2">
          <label class="label">Corner Logo</label>
          <input type="file" accept="image/*" onchange={getCornerURL} class="file-input file-input-bordered w-full" />
        </div>
      </div>
    {/if}

    <button class="btn btn-primary btn-lg" onclick={goToPrint}>
      Continue to Print
    </button>
  </div>
{:else if active === "print"}
  <div class="flex flex-col gap-6 w-full items-center p-6">
    <p class="font-bold text-lg">Your Notes ({$preparedTokens.length})</p>
    
    <div class="flex gap-4 flex-wrap justify-center">
      {#each $preparedTokens as token, i}
        {@const tokenContext = {
          denomination: getAmountForTokenSet(token.proofs),
          mintUrl: $wallet?.mint.mintUrl || "",
          token: getEncodedTokenV4(token),
          unit: token.unit || "sat",
        }}
        <div class="flex flex-col gap-2 items-center">
          <p class="text-sm">Note {i + 1}</p>
          {#if $currentTemplate}
            <div class="scale-25 origin-top">
              <NoteCanvas
                bind:this={canvasRef[i]}
                template={$currentTemplate}
                context={tokenContext}
                editable={false}
              />
            </div>
          {/if}
        </div>
      {/each}
    </div>

    <div class="flex gap-4">
      <button class="btn btn-outline" onclick={() => (active = "customize")}>
        Back to Customize
      </button>
      <button class="btn btn-secondary" onclick={downloadQRs}>
        Download QR Codes
      </button>
      <button class="btn btn-primary" onclick={downloadAll}>
        Download All Notes
      </button>
    </div>
  </div>
{:else if active === "share"}
  <ShareViaNostr></ShareViaNostr>
{/if}
