<script lang="ts">
  import { getDecodedToken, getEncodedTokenV4 } from "@cashu/cashu-ts";
  import "./app.css";
  import ComicNote from "./lib/ComicNote.svelte";
  import { Toaster } from "svelte-sonner";
  import MintSelector from "./features/mint-selection/MintSelector.svelte";
  import NoteCreator from "./features/note-creation/NoteCreator.svelte";
  import PrintHistory from "./features/print-history/PrintHistory.svelte";
  import { mintStore } from "./features/mint-selection/mint-store.svelte";
  import { noteCreationStore } from "./features/note-creation/note-store.svelte";
  import {
    Building2,
    Coins,
    Zap,
    Printer,
    Code,
    Heart,
    Clock,
  } from "lucide-svelte";
  import DonateCashu from "./lib/DonateCashu.svelte";
  import { getAmountForTokenSet } from "./lib/utils";

  // Handle direct token links (for sharing)
  const urlParams = window.location.hash.slice(1).split("/");
  const token = $derived.by(() => {
    const tokenString = urlParams[0];
    try {
      return getDecodedToken(tokenString ?? "");
    } catch (error) {
      return undefined;
    }
  });
  const template = $derived.by(() => {
    const param = urlParams[1];
    if (!param) return 5;
    const design = Number.parseInt(param);
    const d = isNaN(design) ? 5 : design;
    return d;
  });

  // Main app state
  let currentStep = $state(1);
  let showDonate = $state(false);
  let showHistory = $state(false);

  const isMintReady = $derived(mintStore.isReady);
  const isConfigReady = $derived(
    noteCreationStore.denomination > 0 && noteCreationStore.numberOfNotes > 0,
  );

  function goToStep(step: number) {
    // Validate transitions
    if (step === 2 && !isMintReady) return;
    if (step === 3 && (!isMintReady || !isConfigReady)) return;
    if (step === 4 && (!isMintReady || !isConfigReady)) return;

    currentStep = step;
  }

  function handleMintSelected() {
    currentStep = 2;
  }

  function handleNotesConfigured() {
    currentStep = 3;
  }

  function handleReprintSelected(mintUrl: string, tokens: any[], unit: string) {
    // TODO: Implement reprint flow
    console.log("Reprint selected:", { mintUrl, tokens, unit });
    showHistory = false;
    currentStep = 4; // Go to print step
  }
</script>

<Toaster richColors position="top-right" />

{#if token}
  <!-- Direct token link view (for sharing) -->
  <div>
    <ComicNote
      design={template}
      denomination={getAmountForTokenSet(token.proofs)}
      mintUrl={token.mint}
      token={getEncodedTokenV4(token)}
      unit={token.unit ?? "sat"}
    />
  </div>
{:else}
  <!-- Main app flow -->
  <div
    class="min-h-screen w-screen bg-gradient-to-br from-primary to-secondary flex items-center justify-center p-4"
  >
    <div class="w-full max-w-4xl bg-base-100 rounded-2xl shadow-2xl p-6 md:p-8">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold mb-2">
          Money Printer Go <span class="text-primary">BRRRRR</span>
        </h1>
        <p class="text-lg opacity-70">Create physical Cashu notes</p>

        <!-- History Toggle -->
        <button
          class="btn btn-sm btn-ghost mt-2"
          onclick={() => (showHistory = !showHistory)}
        >
          <Clock class="w-4 h-4" />
          {showHistory ? "Hide" : "View"} Print History
        </button>
      </div>

      {#if showHistory}
        <!-- Print History View -->
        <PrintHistory onReprintSelected={handleReprintSelected} />
      {:else}
        <!-- Normal Flow -->

        <!-- Progress Steps -->
        <ul class="steps steps-vertical lg:steps-horizontal w-full mb-8">
          <li
            class="step"
            class:step-primary={currentStep >= 1}
            role="button"
            tabindex="0"
            onclick={() => goToStep(1)}
            onkeypress={(e) => e.key === "Enter" && goToStep(1)}
          >
            <div class="flex items-center gap-2">
              <Building2 class="w-4 h-4" />
              <span class="hidden sm:inline">Select Mint</span>
            </div>
          </li>
          <li
            class="step"
            class:step-primary={currentStep >= 2}
            class:opacity-50={!isMintReady}
            role="button"
            tabindex="0"
            onclick={() => goToStep(2)}
            onkeypress={(e) => e.key === "Enter" && goToStep(2)}
          >
            <div class="flex items-center gap-2">
              <Coins class="w-4 h-4" />
              <span class="hidden sm:inline">Configure</span>
            </div>
          </li>
          <li
            class="step"
            class:step-primary={currentStep >= 3}
            class:opacity-50={!isMintReady || !isConfigReady}
            role="button"
            tabindex="0"
            onclick={() => goToStep(3)}
            onkeypress={(e) => e.key === "Enter" && goToStep(3)}
          >
            <div class="flex items-center gap-2">
              <Zap class="w-4 h-4" />
              <span class="hidden sm:inline">Pay</span>
            </div>
          </li>
          <li
            class="step"
            class:step-primary={currentStep >= 4}
            class:opacity-50={!isMintReady || !isConfigReady}
          >
            <div class="flex items-center gap-2">
              <Printer class="w-4 h-4" />
              <span class="hidden sm:inline">Print</span>
            </div>
          </li>
        </ul>

        <!-- Step Content -->
        <div class="min-h-[400px]">
          {#if currentStep === 1}
            <MintSelector onMintSelected={handleMintSelected} />
          {:else if currentStep === 2}
            <NoteCreator onConfigured={handleNotesConfigured} />
          {:else if currentStep === 3}
            <div class="space-y-6">
              <div class="text-center">
                <Zap class="w-16 h-16 mx-auto text-warning mb-4" />
                <h2 class="text-2xl font-bold mb-2">Payment Step</h2>
                <p class="opacity-70">
                  Coming soon - Lightning invoice payment
                </p>
              </div>

              <!-- Placeholder info -->
              <div class="card bg-base-200">
                <div class="card-body">
                  <p class="text-sm">This step will:</p>
                  <ul
                    class="list-disc list-inside space-y-1 text-sm opacity-70"
                  >
                    <li>
                      Generate Lightning invoice for {noteCreationStore.totalAmount}
                      sats
                    </li>
                    <li>Wait for payment confirmation</li>
                    <li>Mint Cashu tokens from selected mint</li>
                    <li>
                      Split into {noteCreationStore.numberOfNotes} notes of {noteCreationStore.denomination}
                      sats
                    </li>
                  </ul>
                </div>
              </div>

              <div class="flex gap-3">
                <button
                  class="btn btn-outline flex-1"
                  onclick={() => goToStep(2)}
                >
                  Back
                </button>
                <button
                  class="btn btn-primary flex-1"
                  onclick={() => (currentStep = 4)}
                >
                  Skip to Print (Demo)
                </button>
              </div>
            </div>
          {:else if currentStep === 4}
            <div class="space-y-6">
              <div class="text-center">
                <Printer class="w-16 h-16 mx-auto text-success mb-4" />
                <h2 class="text-2xl font-bold mb-2">Print Notes</h2>
                <p class="opacity-70">
                  Coming soon - PDF generation and printing
                </p>
              </div>

              <!-- Placeholder info -->
              <div class="card bg-base-200">
                <div class="card-body">
                  <p class="text-sm">This step will:</p>
                  <ul
                    class="list-disc list-inside space-y-1 text-sm opacity-70"
                  >
                    <li>Generate QR codes for each note</li>
                    <li>Apply selected design template</li>
                    <li>Create optimized PDF with crop marks</li>
                    <li>Auto-arrange notes on pages</li>
                    <li>Download printable PDF</li>
                  </ul>
                </div>
              </div>

              <button
                class="btn btn-outline btn-block"
                onclick={() => goToStep(1)}
              >
                Start Over
              </button>
            </div>
          {/if}
        </div>

        <!-- Footer -->
        <div class="mt-8 pt-6 border-t border-base-300">
          <div class="flex justify-center gap-3">
            <button
              class="btn btn-sm btn-error"
              onclick={() => (showDonate = !showDonate)}
            >
              <Heart class="w-4 h-4" />
              {showDonate ? "Hide" : "Donate"}
            </button>
            <a
              href="https://github.com/gandlafbtc/cashu-brrr"
              class="btn btn-sm btn-info"
              target="_blank"
              rel="noopener noreferrer"
            >
              <Code class="w-4 h-4" />
              Code
            </a>
          </div>

          {#if showDonate}
            <div class="mt-6 space-y-4">
              <div class="text-center text-sm opacity-70">
                <p>
                  Hi anon! If you appreciate the money printer, consider
                  donating some sats.
                </p>
                <p>
                  Value4Value! Let's keep the money printer running.
                  Brrrrrrrrrrrrrrrrr...
                </p>
              </div>

              <div class="flex flex-col gap-3 items-center">
                <DonateCashu />

                <div class="text-xs opacity-60">
                  <a
                    href="https://geyser.fund/project/brrr"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="link link-primary"
                  >
                    geyser.fund/project/brrr
                  </a>
                </div>
              </div>
            </div>
          {/if}
        </div>
      {/if}
    </div>
  </div>
{/if}

<style>
  .steps {
    counter-reset: step;
  }

  .step {
    transition: all 0.2s ease;
  }

  .step.cursor-pointer:hover {
    transform: scale(1.05);
  }
</style>
